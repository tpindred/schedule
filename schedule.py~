import requests
from bs4 import BeautifulSoup
import smtplib  

class user(object):

    def __init__(self, user_info): # user_info is a tuple containing name, pass number, and email
        self.name = user_info[0]
        self.pass_number = user_info[1]
        self.password = 'GCT123'
        self.email = user_info[2]
        self.schedule = []
        self.three_day_outlook = []
        self.yesterdays_hours = None

    def login(self):
        '''
        Logs into the RTP site with the user pass number. 
        Returns the post response object from the login. 
        '''
        get_url = '''
        https://secure.winterparkresort.com/
        WebInstructorTools/instructorTools/login.do
        '''
        post_url = '''
        https://secure.winterparkresort.com/
        WebInstructorTools/instructorTools/processLogin.do
        '''
        payload = {
            'passNumber' : self.pass_number,
            'password' : self.password,
            'loginBtn' : '[+Login+]'
        }
        with requests.Session() as session:
            jar = requests.cookies.RequestsCookieJar()
            jar.set('eComRtpOneId', 'key=2121853-955741&id=resortx&store=resortx', domain='secure.winterparkresort.com')
    
            get = session.get(get_url, cookies=jar)
            jar.set(get.cookies)
            post = session.post(post_url, cookies=jar, data=payload)
            return post

    def update_schedule(self, post_response):
        soup = BeautifulSoup(post_response.text, 'lxml')
        schedule_text = soup.find(id='schedule')
        rows = schedule_text.find_all(class_=re.compile('^row'))
        for row in rows:
            self.schedule.append({})
            for count, child in enumerate(row.children):
                # really need to find more pythonic way than a series of ifs
                if count == 0:
                    self.schedule[-1]['date'] = child.string
                elif count == 1:
                    self.schedule[-1]['hours'] = child.string
                elif count == 2:
                    self.schedule[-1]['activity'] = child.string
        
    def send_email(self):
        try:
            server = smtplib.SMTP('smtp.gmail.com:587')
            server.ehlo()
            server.starttls()
            server.login(username,password)
            server.sendmail(sender, self.email, message)         
            print ("Successfully sent email")
            server.quit()
        except SMTPException:
            print ("Error: unable to send email")
        
        
        
        
    
